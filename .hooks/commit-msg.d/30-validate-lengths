#!/bin/bash
# A git post-commit hook that validates the length of the subject line
# and body of the commit message.

SUBJECT_MAX_LENGTH=50
BODY_MAX_LENGTH=72

ERROR='\e[1;31mError\e[0m:'
WARNING='\e[1;33mWarning\e[0m:'

# ===

COMMIT_MSG_FILE="$1"

TMPFILE="${TMPDIR:-/tmp}/$RANDOM.$RANDOM.$RANDOM.$RANDOM"

# remove comments, then empty lines
grep -Eve "^#" "$COMMIT_MSG_FILE" > "$TMPFILE"

SUBJECT=$(head -n 1 "$TMPFILE")
BODY=$(tail -n +2 "$TMPFILE")
EMPTYLINE=$(head -n 1 <<< "$BODY")

rm "$TMPFILE"

if [[ ${#SUBJECT} -gt $SUBJECT_MAX_LENGTH ]]; then
	printf "$WARNING: Subject longer than 50 chars (counted %d):\n" ${#SUBJECT}
	printf "%s" "$SUBJECT"
fi

if [[ ${#EMPTYLINE} -gt 0 ]]; then
	printf "$ERROR: An empty line must separate the subject and the body.\n"
	printf "%s" "$SUBJECT"
	exit 1
fi

while read -r line
do
	if [[ ${#line} -gt $BODY_MAX_LENGTH ]]; then
		printf "$WARNING: Body longer than 72 chars (counted %d):\n" ${#line}
		printf "%s" "$line"
	fi
done <<< "$BODY"
